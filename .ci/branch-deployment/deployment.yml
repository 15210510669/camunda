apiVersion: apps/v1
kind: Deployment
metadata:
  name: @BRANCH@-operate-camunda-cloud
  labels:
    camunda.cloud/source: "@CAMUNDA_CLOUD_SOURCE@"
    camunda.cloud/managed-by: "@CAMUNDA_CLOUD_MANAGED_BY@"
    app: @BRANCH@-operate-camunda-cloud
    branch: @BRANCH@
    changed: "@CHANGED@"
  annotations:
    camunda.cloud/created-by: "@CAMUNDA_CLOUD_CREATED_BY@"
spec:
  replicas: 1
  revisionHistoryLimit: 0
  strategy:
    rollingUpdate:
      maxUnavailable: 0
  selector:
    matchLabels:
      app: @BRANCH@-operate-camunda-cloud
  template:
    metadata:
      labels:
        camunda.cloud/source: "@CAMUNDA_CLOUD_SOURCE@"
        camunda.cloud/managed-by: "@CAMUNDA_CLOUD_MANAGED_BY@"
        app: @BRANCH@-operate-camunda-cloud
        branch: @BRANCH@
        changed: "@CHANGED@"
      annotations:
        camunda.cloud/created-by: "@CAMUNDA_CLOUD_CREATED_BY@"
    spec:
      nodeSelector:
        cloud.google.com/gke-nodepool: services
      volumes:
        - name: configuration
          configMap:
            name: @BRANCH@-operate-camunda-cloud
            defaultMode: 0744
      initContainers:
        - name: init-sysctl
          image: busybox
          imagePullPolicy: IfNotPresent
          command: ["sysctl", "-w", "vm.max_map_count=262144"]
          securityContext:
            privileged: true
      containers:
        - name: operate
          image: gcr.io/ci-30-162810/camunda-operate:@VERSION@
          imagePullPolicy: Always
          env:
            - name: JAVA_OPTS
              value: |
                -XX:MaxRAMFraction=1
            - name: SPRING_PROFILES_ACTIVE
              value: "dev-data"
          ports:
            - containerPort: 8080
              name: operate-http
          tty: true
          livenessProbe:
            initialDelaySeconds: 30
            periodSeconds: 30
            httpGet:
              path: /
              port: operate-http
          readinessProbe:
            initialDelaySeconds: 30
            periodSeconds: 30
            httpGet:
              path: /
              port: operate-http
          resources:
            limits:
              cpu: 1
              memory: 1Gi
            requests:
              cpu: 0.5
              memory: 512Mi
          volumeMounts:
            - name: configuration
              mountPath: /config/application.yml
              subPath: application.yml
        - name: elasticsearch
          image: docker.elastic.co/elasticsearch/elasticsearch:7.13.0
          env:
            - name: ES_JAVA_OPTS
              value: "-Xms512m -Xmx512m"
            - name: cluster.name
              value: elasticsearch
            - name: discovery.type
              value: single-node
            - name: xpack.security.enabled
              value: "false"
            - name: bootstrap.memory_lock
              value: "true"
            - name: processors
              value: "1"
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
          ports:
            - containerPort: 9200
              name: es-http
              protocol: TCP
            - containerPort: 9300
              name: es-transport
              protocol: TCP
          livenessProbe:
            tcpSocket:
              port: es-transport
            initialDelaySeconds: 30
            periodSeconds: 15
          readinessProbe:
            tcpSocket:
              port: es-transport
            initialDelaySeconds: 30
            periodSeconds: 15
          resources:
            limits:
              cpu: 1
              memory: 1Gi
            requests:
              cpu: 0.5
              memory: 512Mi
        - name: zeebe
          image: camunda/zeebe:1.2.0
          #imagePullPolicy: Always   #this must be uncommented when snapshot is used
          command: ["/bin/sh"]
          args: ["-c", "sleep 20 && tini -s /usr/local/bin/startup.sh"]
          env:
            - name: ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_CLASSNAME
              value: io.camunda.zeebe.exporter.ElasticsearchExporter
            - name: ZEEBE_HOST
              value: 0.0.0.0
            - name: JAVA_TOOL_OPTIONS
              value: |
                -Xms512m
                -Xmx512m
          ports:
            - containerPort: 26500
              name: zeebe-gateway
              protocol: TCP
          resources:
            limits:
              cpu: 1
              memory: 1Gi
            requests:
              cpu: 500m
              memory: 512Mi
