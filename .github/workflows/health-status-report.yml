name: Optimize health status report

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * 1-5"

permissions:
  contents: read
  actions: read

jobs:
  health-status-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@affa6f04da5c2d55e6e115b7d1b044a6b1af8c74 # v2.7.4
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/optimize/ci/camunda-optimize SLACK_API_KEY;
            secret/data/products/optimize/ci/camunda-optimize ARGOCD_TOKEN;
            secret/data/products/optimize/ci/camunda-optimize SNYK_TOKEN;

      - name: Genetare config file
        run: |
          cd ${{ github.workspace }}/.github/scripts/healthStatusReport
          yarn
          npx ts-node createHealthStatusConfig.ts
          cat config.json

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARGOCD_TOKEN: ${{ steps.secrets.outputs.ARGOCD_TOKEN }}
          SNYK_TOKEN: ${{ steps.secrets.outputs.SNYK_TOKEN }}

      - name: Get health status report
        uses: misiekhardcore/infra-report-action@2fd767efd51156126fba0e40c421d73922b701f4 # v1.2.0
        id: get-report
        with:
          config_file_path: ${{ github.workspace }}/.github/scripts/healthStatusReport/config.json
          github_token: ${{ secrets.GITHUB_TOKEN }}
          argocd_token: ${{ steps.secrets.outputs.ARGOCD_TOKEN }}
          snyk_token: ${{ steps.secrets.outputs.SNYK_TOKEN }}

      - name: Send report to slack channel
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: "#optimize-health-status-update"
          slack-message: ${{ steps.get-report.outputs.infra_report }}
        env:
          SLACK_BOT_TOKEN: ${{ steps.secrets.outputs.SLACK_API_KEY }}
