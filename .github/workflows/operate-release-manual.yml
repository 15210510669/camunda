# This GitHub Actions (GHA) workflow is used to manually trigger a release for `operate` application.
#
# It takes several inputs:
# - 'branch': the branch from which to build the release.
# - 'releaseVersion': the version number to apply to the release (in pom.xml and the Git tag).
# - 'nextDevelopmentVersion': the version to use after the release.
# - 'dryRun': if true, the release is built but no changes are made or artifacts (Docker, Maven) are pushed. Defaults to `true`.
# - 'githubUploadRelease': if true, the release will be uploaded to GitHub. Defaults to `false`.
# - 'isLatest': if true, the Docker image will be tagged with the 'latest' tag. Defaults to `false`.
#
# The workflow leverages a reusable workflow (./.github/workflows/operate-release-reusable.yml)
# to perform the actual release process.
#
# It allows you to manually dispatch the workflow with custom input parameters to control the release process.
# This can be done through GitHub's UI by navigating to the "Actions" tab of the `operate` repository, then clicking on the
# "Run workflow" dropdown, selecting the workflow, filling in the input fields and clicking "Run workflow".
#
# Link to Release manual workflow: https://github.com/camunda/zeebe/actions/workflows/release-manual.yml

name: Operate Release manual

on:
  workflow_dispatch:

jobs:
  release:
    name: "create release"
    runs-on: ubuntu-22.04
    steps:
      - name: Import Secrets
        id: secrets # important to refer to it in later steps
        uses: hashicorp/vault-action@v2.8.1
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          exportEnv: false # we rely on step outputs, no need for environment variables
          secrets: |
            secret/data/products/operate/release_process GITHUB_TOKEN;
      - name: Create a release
        env:
          GITHUB_TOKEN: ${{ steps.secrets.outputs.GITHUB_TOKEN }}
        uses: octokit/request-action@v2.1.9
        with:
          route: POST /repos/camunda/zeebe/releases
          draft: true
          name: operate-8.5.0-test1
          tag_name: operate-8.5.0-test1
          body: "" # TODO: changelog too big with Zeebe merge
          generate_release_notes: true
          make_latest: 'false'
