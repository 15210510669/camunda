name: Release Camunda Optimize to Camunda Nexus, DockerHub and internal Harbor registry.

on:
  schedule:
    - cron: "0 0 * * 1-5"
  workflow_dispatch:
    inputs:
      RELEASE_VERSION:
        required: true
        description: 'Version to release. Applied to pom.xml and Git tag.'
        default: '0.0.0'
      DEVELOPMENT_VERSION:
        required: true
        description: 'Next development version.'
        default: '0.1.0-SNAPSHOT'
      BRANCH:
        required: true
        description: 'The branch used for the release checkout.'
        default: '0.0.0'
      DOCKER_LATEST:
        required: true
        description: 'Should the docker image be tagged as latest.'
        default: true
      ADDITIONAL_DOCKER_TAG:
        required: false
        description: 'Any additional tag that should be added to the docker image.'
      DRY_RUN:
        required: true
        description: 'Check if this is an actual release or a dry run.'
        default: 'true'
      RELEASE_EXAMPLES:
        required: true
        description: 'Verify whether the optimize examples repository has to be updated.'
        default: false

jobs:
  build:
    name: Execute Release and Upload to Download Center
    runs-on: gcp-core-2-release
    env:
      DOCKER_IMAGE_TEAM: registry.camunda.cloud/optimize-ee/optimize
      DOCKER_IMAGE_DOCKER_HUB: camunda/optimize
      DOCKER_LATEST_TAG: latest
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v4

      - name: Import Secrets
        id: secrets
        uses: hashicorp/vault-action@affa6f04da5c2d55e6e115b7d1b044a6b1af8c74 # v2.7.4
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/common/jenkins/downloads-camunda-cloud_google_sa_key DOWNLOAD_CENTER_GCLOUD_KEY_BYTES | GCP_CREDENTIALS_NAME;
            secret/data/products/optimize/ci/camunda-optimize GITHUB_OPTIMIZE_APP_ID;
            secret/data/products/optimize/ci/camunda-optimize GITHUB_OPTIMIZE_APP_KEY;
            secret/data/products/infra/ci/common CAMUNDA_NEXUS_USR;
            secret/data/products/infra/ci/common CAMUNDA_NEXUS_PSW;
            secret/data/products/optimize/ci/camunda-optimize REGISTRY_HUB_DOCKER_COM_USR;
            secret/data/products/optimize/ci/camunda-optimize REGISTRY_HUB_DOCKER_COM_PSW;

      - name: "Read Java / Version Info"
        id: "pom-info"
        uses: YunaBraska/java-info-action@main

      - name: Setup Maven
        uses: camunda/camunda-optimize/.github/actions/setup-maven@master
        with:
          secrets: ${{ toJSON(secrets) }}

      - name: Is current release major or manor.
        id: is-major-or-minor
        env:
          RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION || '0.0.0' }}
        run: |
          is_major_or_minor="false"
          is_patch="true"
          patch_version=$(echo "$RELEASE_VERSION" | cut -d. -f3)
          if [[ ! "$patch_version" == *"-"* ]] && [[ "$patch_version" == "0" ]]; then
            is_major_or_minor="true"
            is_patch="false"
            echo "is_patchr=$is_patch"
            echo "is_major_or_minor=$is_major_or_minor"
          fi
          echo "is_major_or_minor=$is_major_or_minor" >> "$GITHUB_OUTPUT"
          echo "is_patch=$is_patch" >> "$GITHUB_OUTPUT"

      - name: Generate a GitHub token
        id: github-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ steps.secrets.outputs.GITHUB_OPTIMIZE_APP_ID }}
          private_key: ${{ steps.secrets.outputs.GITHUB_OPTIMIZE_APP_KEY }}

      - name: Install common tooling (buildx)  # required on self-hosted runners
        uses: camunda/infra-global-github-actions/common-tooling@main
        with:
          buildx-enabled: true
          java-enabled: false
          node-enabled: false
          python-enabled: false
          yarn-enabled: false

      - name: Define common variables
        id: define-values
        uses: ./.github/actions/git-environment

      - name: Expose common variables as Env
        env:
          RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION || '0.0.0' }}
        run: |
          {
          echo "VERSION=$RELEASE_VERSION"
          echo "REVISION=${{ steps.define-values.outputs.git_commit_hash }}"
          } >> "$GITHUB_ENV"

      - name: Login to prod Harbor docker registry
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3
        with:
          registry: registry.camunda.cloud
          username: ${{ steps.secrets.outputs.CAMUNDA_NEXUS_USR }}
          password: ${{ steps.secrets.outputs.CAMUNDA_NEXUS_PSW }}

      - name: Login to docker hub
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3
        with:
          username: ${{ steps.secrets.outputs.REGISTRY_HUB_DOCKER_COM_USR }}
          password: ${{ steps.secrets.outputs.REGISTRY_HUB_DOCKER_COM_PSW }}

      - name: Run Maven
        shell: bash
        env:
          RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION || '0.0.0' }}
          DEVELOPMENT_VERSION: ${{ github.event.inputs.DEVELOPMENT_VERSION || '0.1.0-SNAPSHOT' }}
          BRANCH: ${{ github.event.inputs.BRANCH || github.ref_name}}
          GITHUB_TOKEN: ${{ steps.github-token.outputs.token }}
          GITHUB_APP_ID: ${{ steps.secrets.outputs.GITHUB_OPTIMIZE_APP_ID }}
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'true' }}
        run: |
          .github/scripts/execute-release.sh

      # This still needs changing once we are on prod
      - name: Upload artifact to Camunda Download Center
        if: inputs.DRY_RUN == 'false'
        uses: camunda/infra-global-github-actions/download-center-upload@modify_download_center
        with:
          gcp_credentials: ${{ steps.secrets.outputs.GCP_CREDENTIALS_NAME }}
          ee: 'true'
          env: 'prod'
          version: ${{ github.event.inputs.RELEASE_VERSION }}
          artifact_file: target/checkout/distro/target/*.{tar.gz,zip}
          repo_name: 'optimize'

      - name: Auto-update previous version
        env:
          GITHUB_TOKEN: ${{ steps.github-token.outputs.token }}
          GITHUB_APP_ID: ${{ steps.secrets.outputs.GITHUB_OPTIMIZE_APP_ID }}
          IS_PATCH: ${{ steps.is-major-or-minor.outputs.is_patch }}
          RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION || '0.0.0' }}
          BRANCH: ${{ github.event.inputs.BRANCH }}
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'true'}}
        run: |
          git checkout ${{ github.ref_name }}
          .github/scripts/update-previous-version.sh

      - name: Build Docker Image
        run: |
          .github/scripts/build-release-docker-images.sh
        env:
          MAJOR_OR_MINOR:  ${{ steps.is-major-or-minor.outputs.is_major_or_minor }}
          DOCKER_LATEST: ${{ github.event.inputs.DOCKER_LATEST }}
          ADDITIONAL_DOCKER_TAG: ${{ github.event.inputs.ADDITIONAL_DOCKER_TAG }}
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'true' }}

      - name: Start Smoketest
        uses: ./.github/actions/compose
        with:
          compose_file: ${{ github.workspace }}/.github/actions/compose/docker-compose.smoketest.release.yml
          project_name: smoketest
        env:
          OPTIMIZE_IMAGE_TAG: ${{ github.event.inputs.RELEASE_VERSION }}
          ELASTIC_VERSION: ${{ steps.pom-info.outputs.x_elasticsearch8_test_version }}
          CAMBPM_HOST: "172.17.0.1"
          CAMBPM_PORT: "8080"
            # ^ starting ~2023-10-10, the hostname resolution for the cambpm docker-compose service
            # http://cambpm:8080 does not work anymore for neither SaaS nor self-hosted Linux runners.
            # 172.17.0.1 is the host IP address from the container perspective, and cambpm is running
            # exposed there on port 8080.

      - name: Execute health check and push docker image
        uses: ./.github/actions/execute-healthcheck-and-push-images
        with:
          version: ${{ env.VERSION }}
          date: ${{ env.DATE }}
          revision:  ${{ env.REVISION }}
        env:
          DRY_RUN: ${{ github.event.inputs.DRY_RUN || 'true' }}

      - name: Docker log dump
        uses: ./.github/actions/docker-logs
        with:
          archive_name: deploy-artifacts-docker

      - name: Checkout Optimize examples
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          token: ${{ steps.github-token.outputs.token }}
          repository: camunda/camunda-optimize-examples
          path: camunda-optimize-examples
          ref: master

      - name: Trigger release examples repo
        if: inputs.RELEASE_EXAMPLES == 'true'
        working-directory: camunda-optimize-examples
        env:
          GITHUB_TOKEN: ${{ steps.github-token.outputs.token }}
          GITHUB_APP_ID: ${{ steps.secrets.outputs.GITHUB_OPTIMIZE_APP_ID }}
          RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION }}
          DEVELOPMENT_VERSION: ${{ github.event.inputs.DEVELOPMENT_VERSION }}
          BRANCH: ${{ github.event.inputs.BRANCH }}
        run: |
          ../.github/scripts/update_example_repo.sh
