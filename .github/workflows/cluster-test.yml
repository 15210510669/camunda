name: Optimize Cluster Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 1-5"

jobs:
  optimize-cluster-test:
    runs-on: gcp-core-8-default
    timeout-minutes: 60
    env:
      NAMESPACE: optimize-cluster-test-${{ github.run_id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

    - name: Import secrets
      id: secrets
      uses: hashicorp/vault-action@affa6f04da5c2d55e6e115b7d1b044a6b1af8c74 # v2.7.4
      with:
        url: ${{ secrets.VAULT_ADDR }}
        method: approle
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}
        secrets: |
          secret/data/products/optimize/ci/camunda-optimize CI_SERVICE_ACCOUNT | GCP_CREDENTIALS;
          secret/data/products/optimize/ci/camunda-optimize SLACK_BOT_URL;

    - name: Setup Maven
      uses: ./.github/actions/setup-maven
      with:
          secrets: ${{ toJSON(secrets) }}
          java-version: 17
          distribution: zulu

    - name: Install extra Dependencies
      run: |
        sudo apt update -qq
        sudo apt install -y netcat

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@67e9c72af6e0492df856527b474995862b7b6591 # v2
      with:
        credentials_json: ${{ steps.secrets.outputs.GCP_CREDENTIALS }}

    - name: Get gcloud credentials
      uses: 'google-github-actions/get-gke-credentials@0ee75eea82b114e2ac06176587c52970953206cf' # v2
      with:
        cluster_name: 'camunda-ci'
        location: 'europe-west1'

    - name: Configure Google SDK
      uses: google-github-actions/setup-gcloud@825196879a077b7efa50db2e88409f44de4635c2 # v2.0.0
      with:
        install_components: gke-gcloud-auth-plugin, kubectl

    - name: Read pom.xml file
      id: pom-info
      uses: YunaBraska/java-info-action@main

    - name: Deploy cluster
      run: .github/podSpecs/clusterTests/deploy.sh $NAMESPACE ${{ steps.pom-info.outputs.x_elasticsearch8_test_version }} ${{ steps.pom-info.outputs.x_camunda_engine_version }}

    - name: Run Tests
      uses: ./.github/actions/run-maven
      with:
          parameters: >-
                  -B -Pclustering-tests verify -pl qa/clustering-tests
                  -Doptimize.importing.host=optimize-import.$NAMESPACE -Doptimize.importing.port=8090
                  -Doptimize.notImporting.host=optimize-no-import.$NAMESPACE -Doptimize.notImporting.port=8090
                  -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

    - name: Store elasticsearch logs
      if: always()
      run: kubectl -n $NAMESPACE logs elasticsearch-0 -c elasticsearch > elasticsearch.log

    - name: Cluster cleanup
      if: always()
      run: .github/podSpecs/clusterTests/kill.sh $NAMESPACE

    - uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # v4
      if: always()
      with:
        name: elasticsearch-logs
        path: ./elasticsearch.log

    - name: Post results on slack
      if: failure()
      uses: ./.github/actions/notify-on-slack
      with:
        slack_webhook_url: ${{ steps.secrets.outputs.SLACK_BOT_URL}}
        status: ${{ job.status }}
