
name: Static Code Analysis
on:
  pull_request:

# Will limit the workflow to 1 concurrenct run per ref (branch / PR)
# If a new commits occurs, the current run will be canceled
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sonarqube:
    name: SonarQube - Java
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      with:
        fetch-depth: 0
    - name: Import secrets
      id: secrets
      uses: hashicorp/vault-action@86c7f837eb43794c7dc56f74d9cffac710679b28
      with:
        url: ${{ secrets.VAULT_ADDR }}
        method: approle
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}
        secrets: |
          secret/data/products/optimize/ci/jenkins SONARCLOUD_TOKEN;
    - name: Setup Maven
      uses: ./.github/actions/setup-maven
      with:
        secrets: ${{ toJSON(secrets) }}
    - name: Test Compile
      uses: ./.github/actions/run-maven
      with:
        parameters: test-compile -Dskip.fe.build
    - name: Run SonarQube script
      run: |
        # This step is needed to fetch repo branches so SonarQube can diff them.
        # It's used to scan and report only differences instead whole branch.
        .ci/scripts/sonarqube-mvn.sh
      env:
        SONARCLOUD_TOKEN: ${{ steps.secrets.outputs.SONARCLOUD_TOKEN }}
        GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
