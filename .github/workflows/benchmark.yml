# Creates and starts a benchmark cluster
name: Benchmark

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Specifies the branch to benchmark'
        default: 'main'
        required: false
  pull_request:

jobs:
  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:    
      - uses: actions/checkout@v3
        with:
          ref: "${{ github.event.inputs.branch }}"
      
      - name: determine benchmark name
        run: |
          echo "CURRENT_CW=$(date +%V)" >> $GITHUB_ENV
          echo "CURRENT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "BENCHMARK_NAME=medic-cw-$CURRENT_CW-$CURRENT_SHA-benchmark" >> $GITHUB_ENV

      - name: merge branch into medic-cw-benchmarks
        run: |
          git fetch origin medic-cw-benchmarks
          git checkout medic-cw-benchmarks
          git merge ${{ github.event.inputs.branch }} --no-edit
          # git push origin medic-cw-benchmarks
      
      - uses: ./.github/actions/setup-zeebe
        with:
          maven-cache: 'true'
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          maven-extra-args: -T1C
      - uses: ./.github/actions/build-docker
        with:
          repository: gcr.io/zeebe-io/zeebe
          version: ${{ env.BENCHMARK_NAME }}
          push: false
          distball: ${{ steps.build-zeebe.outputs.distball }}

      - name: build benchmark project
        run: |
          cd benchmarks/project
          sed -i -e "s/:SNAPSHOT/:$BENCHMARK_NAME/" docker-compose.yml
          # Use --no-cache to force re-build the application.
          # Without this flag, changes to zeebe-client were not picked up.
          # This can take longer to build than usual.
          docker compose build --no-cache
          # docker-compose push