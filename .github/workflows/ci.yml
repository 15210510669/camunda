# This GitHub Actions workflow that is triggered on push to `master` and `stable/**` branch or on any pull request creation
# and invokes `ci-build-reusable` and `ci-test-reusable` workflows.

name: CI
on:
  workflow_dispatch:
  push:
    branches:
      - 'master'
      - 'stable/**'
  pull_request:

jobs:
  run-build:
    name: run-build
    uses: ./.github/workflows/ci-build-reusable.yml
    secrets: inherit
    with:
      branch: ${{ github.head_ref || github.ref_name }} # head_ref = branch name on PR, ref_name = `master` or `stable/**`

  run-tests:
    name: "run-${{ matrix.name }}-tests"
    strategy:
      fail-fast: false
      matrix:
        database: [ elasticsearch, opensearch ]
        include:
          - database: elasticsearch
            testProfile: docker-es
            name: es
          - database: opensearch
            testProfile: docker-os
            name: os
    uses: ./.github/workflows/ci-test-reusable.yml
    secrets: inherit
    with:
      branch: ${{ github.head_ref || github.ref_name }}
      testProfile: ${{ matrix.testProfile }}
      database: ${{ matrix.database }}