name: CI

on:
  push:
    branches:
      - main
      - stable/*
      - release-*
      - trying
      - staging
  pull_request: { }
  merge_group: { }
  workflow_dispatch: { }
  workflow_call: { }

defaults:
  run:
    # use bash shell by default to ensure pipefail behavior is the default
    # see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
    shell: bash

env:
  DOCKER_PLATFORMS: "linux/amd64,linux/arm64"
  # may resolve broken dependencies by enforcing checksum comparison of dependencies, and
  # temporarily switch to the old wagon transport until the next maven release (3.9.2?) is out
  # containing the fix for https://issues.apache.org/jira/browse/MRESOLVER-326
  # additionally disable connection pooling to avoid issues with forcefully closed connections, and
  # reaping connections after 2 minutes
  MAVEN_ARGS: -Dmaven.wagon.httpconnectionManager.ttlSeconds=120 -Dmaven.wagon.http.pool=false -Dmaven.resolver.transport=wagon -U

jobs:
  smoke-tests:
    name: Smoke tests on ${{ matrix.os }} with ${{ matrix.arch }}
    timeout-minutes: 20
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos ]
        arch: [ amd64 ]
        include:
          - os: macos
            runner: macos-latest
    env:
      JAVA_TOOL_OPTIONS: -XX:+TieredCompilation -XX:TieredStopAtLevel=1 -XX:ReservedCodeCacheSize=64M
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-zeebe
        with:
          go: false
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          go: false
          maven-extra-args: >
            -T1C -e -U
            -Dmaven.wagon.httpconnectionManager.ttlSeconds=120 -Dmaven.wagon.http.pool=false -Dmaven.resolver.transport=wagon
            -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.requestSentEnabled=true
            -Dmaven.wagon.http.retryHandler.count=5 -Dhttp.keepAlive=false
      - name: Debug m2 repository
        run: ls -lashR $HOME/.m2/repository/org/jacoco
      - name: Collect m2 repository
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: Jacoco artifacts for ${{ inputs.name  }}
          path: $HOME/.m2/repository/org/jacoco
          retention-days: 1
          if-no-files-found: ignore
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: always()
        with:
          name: Smoke Tests on ${{ matrix.os }} with ${{ matrix.arch }}
