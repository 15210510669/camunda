name: poc-observability

on:
  push: {}

defaults:
  run:
    # use bash shell by default to ensure pipefail behavior is the default
    # see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
    shell: bash

env:
  DOCKER_PLATFORMS: "linux/amd64,linux/arm64"

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Import Secrets
      id: secrets
      uses: hashicorp/vault-action@v3.0.0
      with:
        url: ${{ secrets.VAULT_ADDR }}
        method: approle
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}
        exportEnv: false # we rely on step outputs, no need for environment variables
        secrets: |
            secret/data/products/zeebe/ci/ci-analytics-dev gcloud_sa_key;
    - if: always()
      run: |
        echo "$RUNNER_ARCH"
        echo "$RUNNER_NAME"
        echo "$RUNNER_OS"
        echo "$GITHUB_RUN_ID/$GITHUB_RUN_ATTEMPT"
        echo "xx${{ github.base_ref }}yy"
        echo "xx${{ github.event.merge_group.base_ref }}yy"
        echo "xx${{ github.base_ref && format('refs/heads/{0}', github.base_ref) || github.event.merge_group.base_ref }}yy"
        echo "${{ contains(steps.*.outcome, 'success') }}"
        echo "${{ contains(steps.*.outcome, 'failure') }}"
        echo "${{ contains(steps.*.outcome, 'failure') && 'failure' || 'success' }}"


    - uses: camunda/infra-global-github-actions/submit-build-status@new-build-status-metadata-runner
      if: always()
      with:
        build_status: "${{ contains(steps.*.outcome, 'failure') && 'failure' || 'success' }}"
        gcp_credentials_json: "${{ steps.secrets.outputs.gcloud_sa_key }}"
        big_query_table_name: "ci-30-162810:dev_ci_analytics.build_status_v2"
