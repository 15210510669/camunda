---
name: deploy-env
on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Name of deployment.'
        required: false
        default: latest
      chart_ref:
        description: 'Deployable ref, commit or branch. This will be checked out.'
        required: true
      es_version:
        description: 'ES docker tag to deploy'
        required: true
      zeebe_version:
        description: 'Zeebe docker tag to deploy'
        required: true
      identity_version:
        description: 'Identity docker tag to deploy'
        required: true
      cambpm_version:
        description: 'Cambpm docker tag to deploy'
        required: true

jobs:
  deploy-preview:
    timeout-minutes: 10
    concurrency: deploy-${{ github.events.inputs.ref }}
    name: Deploy Preview Environment
    runs-on: ubuntu-20.04
    steps:
      #########################################################################
      # Setup: import secrets from vault
      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@32838a0d48bc1a2af6fff49957a16e0298b980da
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/optimize/ci/camunda-optimize ARGOCD_TOKEN;
      #########################################################################
      # Setup: checkout code. This is required because we are using
      # composite actions and deployment manifests.
      - name: Checkout
        uses: actions/checkout@v3
      #########################################################################
      # Create a preview environment
      - name: Deploy Preview Environment
        uses: ./.github/actions/deploy-env
        with:
          deployment_id: ${{ github.event.inputs.app_name == 'master' && 'stage' || github.event.inputs.app_name }}
          revision: ${{ github.event.inputs.chart_ref }}
          es_version: ${{ github.event.inputs.es_version }}
          zeebe_version: ${{ github.event.inputs.zeebe_version }}
          identity_version: ${{ github.event.inputs.identity_version }}
          cambpm_version: ${{ github.event.inputs.cambpm_version }}
          argocd_token: ${{ steps.secrets.outputs.ARGOCD_TOKEN }}
