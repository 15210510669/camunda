name: Sonarqube Analysis

on:
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * 1-5

jobs:
  sonarqube-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@9f522b85981b491eab9a52c144d15aedbd0bf371 # v2.8.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/optimize/ci/jenkins SONARCLOUD_TOKEN;
            secret/data/products/optimize/ci/camunda-optimize SLACK_BOT_URL;

      - name: Setup Maven
        uses: ./.github/actions/setup-maven
        with:
          secrets: ${{ toJSON(secrets) }}

      - name: Run Sonarqube Analysis
        uses: ./.github/actions/run-maven
        with:
          parameters: verify sonar:sonar -DskipTests -Dskip.docker -Pit,coverage -pl backend,upgrade,util/optimize-reimport-preparation,test-coverage -am -Dsonar.projectKey=camunda_camunda-optimize -Dsonar.login=${{ steps.secrets.outputs.SONARCLOUD_TOKEN }}

      - name: Post results on slack
        if: failure()
        uses: ./.github/actions/notify-on-slack
        with:
          slack_webhook_url: ${{ steps.secrets.outputs.SLACK_BOT_URL}}
          status: ${{ job.status }}
