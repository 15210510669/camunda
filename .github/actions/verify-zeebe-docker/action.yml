# This action expects the docker to be setup beforehand
---
name: Verify Zeebe Docker Image
description: Verifies metadata of the Zeebe Docker image

inputs:
  imageName:
    description: 'Full name of the image, without the tag.'
    required: true
  date:
    description: 'Date when the image to verify was built, used to verify the date label of the image.'
    required: true
  version:
    description: 'Version tag of the image to verify.'
    required: true
  revision:
    description: 'Revision from which the image to verify was built, used to verify the date label of the image.'
    required: true
  architectures:
    # See https://docs.docker.com/build/ci/github-actions/examples/#multi-platform-images
    description: 'Comma separated-list of linux architectures to verify (linux/${arch}), defaults to `amd64`.'
    required: false
    default: 'amd64'

runs:
  using: composite
  steps:
    - name: Verify Docker image
      id: verify-docker-image
      shell: bash
      env:
        DATE: ${{ inputs.date }}
        REVISION: ${{ inputs.revision }}
        VERSION: ${{ inputs.version }}
        ARCHS_RAW: ${{ inputs.architectures }}
      run: |
        declare -a archs=(${ARCHS_RAW//,/ })

        for arch in "${archs[@]}"; do
          docker pull --platform "linux/$arch" "${{ inputs.imageName }}:${VERSION}"
          ${PWD}/docker/test/verify.sh "${{ inputs.imageName }}:${VERSION}" "$arch"
        done
