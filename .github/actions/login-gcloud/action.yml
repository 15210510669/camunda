name: Login to Google Cloud
description: |
  Local action to simplify login to Google Cloud
inputs:
  secrets:
    description: JSON wrapped secrets for easier secret passing
    required: true
  project_id:
    description: Google Cloud project ID
    required: false
    default: ci-30-162810
runs:
  using: composite
  steps:
    - name: Import secrets
      id: secrets
      uses: hashicorp/vault-action@00bce0da9c4b8be526718f7f5f20a88966f31022
      with:
        url: ${{ fromJSON(inputs.secrets).VAULT_ADDR }}
        method: approle
        roleId: ${{ fromJSON(inputs.secrets).VAULT_ROLE_ID }}
        secretId: ${{ fromJSON(inputs.secrets).VAULT_SECRET_ID }}
        secrets: |
          secret/data/products/optimize/ci/camunda-optimize CI_SERVICE_ACCOUNT | GCP_CREDENTIALS;
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@f6de81663f7788d05bd15bcce18f0e57f23f0846 # v2
      with:
        credentials_json: ${{ steps.secrets.outputs.GCP_CREDENTIALS }}

    - name: Configure Google SDK
      uses: google-github-actions/setup-gcloud@5a5f7b85fca43e76e53463acaa9d408a03c98d3a # v2.0.1
      with:
        project_id: ${{ inputs.project_id }}
        install_components: gke-gcloud-auth-plugin, kubectl
