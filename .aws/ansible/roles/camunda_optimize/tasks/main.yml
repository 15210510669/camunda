---
- name: Ensure camunda group is present
  group:
    name: "{{ camunda_group }}"
    state: present
  become: yes

- name: Ensure camunda system user is present
  user:
    name: "{{ camunda_user }}"
    system: yes
    shell: "/sbin/nologin"
    group: "{{ camunda_group }}"
    createhome: no
    state: present
  become: yes

- name: Download tarball of Camunda Optimize
  get_url:
    url: "{{ nexus_url }}/service/local/artifact/maven/redirect?r=camunda-optimize-snapshots&g=org.camunda.optimize&a=camunda-optimize&v={{ camunda_optimize_version }}&e=tar.gz"
    dest: /tmp/camunda-optimize.tar.gz
    force_basic_auth: yes
    url_username: "{{ nexus_username }}"
    url_password: "{{ nexus_password }}"
  become: yes

- name: Ensure Camunda Optimize installation directory exists
  file:
    path: "{{ camunda_optimize_dir }}"
    owner: "{{ camunda_user }}"
    group: "{{ camunda_group }}"
    state: directory
  become: yes

- name: Unarchive tarball of latest Camunda Optimize
  unarchive:
    src: /tmp/camunda-optimize.tar.gz
    dest: "{{ camunda_optimize_dir }}"
    owner: "{{ camunda_user }}"
    group: "{{ camunda_group }}"
    remote_src: yes
  become: yes

- name: Configure Camunda Optimize (Camunda BPM Endpoint)
  template:
    src: environment/environment.properties.j2
    dest: "{{ camunda_optimize_dir }}/environment/environment.properties"
    owner: "{{ camunda_user }}"
    group: "{{ camunda_group }}"
    mode: 0644
  become: yes

- name: Set ownership of Camunda Optimize install directory to Camunda user {{ camunda_user }} and Camunda group {{ camunda_group }}
  file:
    path: "{{ camunda_optimize_dir }}"
    state: directory
    recurse: yes
    owner: "{{ camunda_user }}"
    group: "{{ camunda_group }}"
  become: yes

- name: Ensure Camunda Optimize systemd service unit exists
  template:
    src: etc/systemd/system/camunda-optimize.service.j2
    dest: /etc/systemd/system/camunda-optimize.service
    owner: root
    group: root
    mode: 0644
  become: yes

- name: Ensure Camunda Optimize systemd service is enabled and started
  systemd:
    name: camunda-optimize
    state: started
    daemon_reload: yes
  become: yes
