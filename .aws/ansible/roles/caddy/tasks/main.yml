---
- name: Update cache
  apt:
    update_cache: yes

- name: Install git
  apt:
    name: git
    state: present
  when: caddy_features | search('git')

- name: Install libcap
  apt:
    name: libcap2-bin
    state: present

- name: Create Caddy user
  user:
    name: "{{ caddy_user }}"
    system: yes
    createhome: yes
    home: "{{ caddy_home }}"
    uid: "{{ caddy_uid }}"

- name: Download binary
  get_url:
    url: https://caddyserver.com/download/build?os=linux&arch=amd64&features={{ caddy_features }}
    dest: "{{ caddy_home }}/caddy.tar.gz"
    force: yes

- name: Extract archive
  unarchive:
    src: "{{ caddy_home }}/caddy.tar.gz"
    dest: "{{ caddy_home }}"
    owner: "{{ caddy_user }}"
    remote_src: yes

- name: Copy binary
  copy:
    src: "{{ caddy_home }}/caddy"
    dest: /usr/local/bin/
    mode: 0755
    remote_src: yes

- name: Ensure Caddy directories are there
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ caddy_user }}"
    mode: 0700
  with_items:
    - "{{ caddy_config_dir }}"
#    - /etc/ssl/caddy
    - /var/log/caddy

- name: Create Caddyfile
  copy:
    content: "{{caddy_config}}"
    dest: "{{ caddy_config_dir }}"/Caddyfile
    owner: "{{ caddy_user }}"

- name: Create Caddy Systemd service
  template:
    src: caddy.service.j2
    dest: /etc/systemd/system/caddy.service
    mode: 0644

- name: Check if the binary can bind to TCP port <1024
  shell: getcap /usr/local/bin/caddy | grep cap_net_bind_service
  failed_when: False
  changed_when: False
  register: caddy_bind_cap

- name: Set capability on the binary file to be able to bind to TCP port <1024
  command: setcap cap_net_bind_service=+ep /usr/local/bin/caddy
  when: caddy_bind_cap.rc > 0

- name: Start Caddy Systemd service
  systemd:
    name: caddy
    state: restarted
    enabled: yes
    daemon_reload: yes
